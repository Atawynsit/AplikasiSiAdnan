<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Generator Surat Pernyataan â€” A4 Fix</title>

<style>
/* GAYA TAMPILAN SAMA SEPERTI SEBELUMNYA */
:root{--accent:#0b5ed7;--muted:#6b7280}
body{font-family:Inter, system-ui, -apple-system, sans-serif; margin:0;background:#f3f6fa;color:#0b2545}
.wrap{max-width:1100px;margin:18px auto;padding:18px}
.card{background:#fff;border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(12,24,60,0.06)}
h1 {
    font-size: 26px;       /* Ukuran Font Besar */
    font-weight: 900;      /* Sangat Tebal */
    text-align: center;    /* Posisi di Tengah */
    margin: 0 0 10px;      /* Jarak ke bawah */
    color: #0b2545;        /* Warna teks */
    text-transform: uppercase; /* Huruf Besar Semua (Opsional, biar gagah) */
    letter-spacing: 1px;   /* Jarak antar huruf */
}
label{display:block;font-size:13px;margin-top:10px;color:var(--muted);font-weight:600;}
input[type=text], input[type=date], input[type=file]{width:100%;padding:10px;border:1px solid #e6eefc;border-radius:8px;font-size:14px;box-sizing:border-box; margin-top: 4px;}
.grid{display:grid;grid-template-columns:1fr 520px;gap:18px}
.note{font-size:13px;color:var(--muted);margin-top:8px}
/* Fix Preview Frame untuk A4 */
.preview-frame{border:1px solid #e6eefc;padding:18px;border-radius:8px;background:#fff;min-height:1120px; display:flex; justify-content:center;}

.letter{font-family: 'Times New Roman', serif;color:#000;padding:28px;width:210mm;box-sizing:border-box; background: white;}
.title{ text-align:center;font-weight:bold;font-size:16pt }
.subtitle{ text-align:center;font-size:11pt;margin-top:4px;margin-bottom:18px }
.signature-img{max-width:180px;display:block}
.btn{background:var(--accent);color:white;border:0;padding:12px 14px;border-radius:8px;cursor:pointer;font-weight:600; width: 100%; transition: 0.2s; margin-top: 10px;}
.btn:hover {opacity: 0.9;}
.btn:disabled {background: #ccc; cursor: not-allowed;}
.btn.ghost{background:transparent;border:1px solid #dbe9ff;color:var(--accent); width: auto; padding: 8px 12px; font-size: 12px; margin-top:0;}
.status{margin-top:12px;font-size:13px; padding: 10px; border-radius: 4px; display: none;}
.status.loading {background: #e2e3e5; color: #383d41; display: block;}
.status.success {background: #d1e7dd; color: #0f5132; display: block;}
.status.error {background: #f8d7da; color: #842029; display: block;}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <h1>Sistem Informasi Pernyataan Anti-Gratifikasi dan Penyuapan (SIADNAN)</h1>
    <p class="note">Isi form, tanda tangan, lalu klik simpan. File akan otomatis masuk ke folder Drive.</p>

    <div class="grid">
      <div>
        <label>Nama</label>
        <input id="nama" type="text" placeholder="Nama lengkap" />

        <label>Instansi / Perusahaan</label>
        <input id="instansi" type="text" placeholder="Contoh: Ditjen Perbendaharaan" />

        <label>Jabatan / Posisi</label>
        <input id="jabatan" type="text" placeholder="Contoh: Pelaksana" />

        <label>Tempat (ttd)</label>
        <input id="tempat" type="text" placeholder="Contoh: Jakarta" />

        <label>Tanggal (ttd)</label>
        <input id="tanggal" type="date" />

        <label>Tanda Tangan</label>
        <div class="note">Gambar tanda tangan di kotak ini:</div>
        <canvas id="sigCanvas" width="420" height="150" style="border:2px dashed #ccc;border-radius:6px;display:block;margin-top:8px;background:#fff; touch-action: none; width: 100%;"></canvas>

        <div style="display:flex;gap:8px;margin-top:8px; align-items: center;">
          <button class="btn ghost" id="clearSig" style="color: crimson; border-color: crimson;">Hapus</button>
          <button class="btn ghost" id="undoSig">Undo</button>
        </div>
        
        <label style="margin-top:15px;">Atau Upload Gambar:</label>
        <input id="uploadSig" type="file" accept="image/*" style="margin-top:0;" />
        <button class="btn ghost" id="useUpload" style="margin-top:5px; width:100%;">Pakai Gambar Upload</button>

        <button class="btn" id="doAll">SIMPAN PDF KE FOLDER</button>
        <div class="status" id="status"></div>
      </div>

      <div>
        <div class="card" style="padding:12px; background: #525659;">
          <div id="preview" class="preview-frame"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// ==========================================
// 1. PASTE URL BARU ANDA DI SINI
// ==========================================
const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQnMvPuxsX6aah6LJxBZxLP6FPPz3SU4spkp3eQvzNHbBEAX0kY2FtuJR5mswswIGTmA/exec"; 

// ==========================================
// 2. LOGIKA CANVAS & PREVIEW
// ==========================================
const canvas = document.getElementById('sigCanvas');
const ctx = canvas.getContext('2d');
let drawing=false, paths=[], uploadedSig='', isUsingUpload=false;

function getPos(e) {
  const r = canvas.getBoundingClientRect();
  const x = (e.touches?e.touches[0].clientX:e.clientX) - r.left;
  const y = (e.touches?e.touches[0].clientY:e.clientY) - r.top;
  return {x: x*(canvas.width/r.width), y: y*(canvas.height/r.height)};
}
const start=e=>{drawing=true;paths.push([getPos(e)]);draw()}
const move=e=>{if(!drawing)return;e.preventDefault();paths[paths.length-1].push(getPos(e));draw()}
const end=()=>{drawing=false;refreshPreview()}

canvas.addEventListener('mousedown',start); canvas.addEventListener('mousemove',move); canvas.addEventListener('mouseup',end);
canvas.addEventListener('touchstart',start); canvas.addEventListener('touchmove',move); canvas.addEventListener('touchend',end);

function draw(){ 
  ctx.clearRect(0,0,canvas.width,canvas.height); ctx.lineWidth=2.5; ctx.lineCap='round'; ctx.strokeStyle='#000'; 
  for(const p of paths){ if(!p.length)continue; ctx.beginPath(); ctx.moveTo(p[0].x,p[0].y); for(let i=1;i<p.length;i++) ctx.lineTo(p[i].x,p[i].y); ctx.stroke(); } 
  if(uploadedSig && isUsingUpload) drawUploaded(uploadedSig);
}

document.getElementById('clearSig').onclick=()=>{paths=[];uploadedSig='';isUsingUpload=false;draw();refreshPreview();}
document.getElementById('undoSig').onclick=()=>{paths.pop();draw();refreshPreview();}

document.getElementById('uploadSig').onchange=(ev)=>{ 
    const f=ev.target.files[0]; if(!f)return; 
    const r=new FileReader(); r.onload=e=>{uploadedSig=e.target.result;isUsingUpload=true;draw();refreshPreview();}; r.readAsDataURL(f);
};
document.getElementById('useUpload').onclick=()=>{if(uploadedSig){isUsingUpload=true;draw();refreshPreview();}};
function drawUploaded(d){const i=new Image();i.onload=()=>{ctx.drawImage(i,10,10,150,100);};i.src=d;}

const templateParagraphs = [
  'Saya menyadari sepenuhnya bahwa pemberian/penerimaan suap dan gratifikasi merupakan perbuatan korupsi yang menciderai nilai integritas dan melanggar norma hukum.',
  'Saya memahami dan mendukung penuh kebijakan pencegahan gratifikasi, benturan kepentingan, dan penguatan integritas di lingkungan Kementerian Keuangan, khususnya Direktorat Jenderal Perbendaharaan.',
  'Saya berkomitmen untuk tidak memberikan uang, hadiah, fasilitas, komisi, imbalan, hiburan, ataupun bentuk pemberian lainnya kepada pejabat/pegawai di lingkungan Direktorat Jenderal Perbendaharaan.',
  'Saya bersedia melaporkan kepada pimpinan Ditjen Perbendaharaan melalui saluran pelaporan yang tersedia apabila mengetahui adanya pelanggaran.',
  'Saya akan meneruskan pesan komitmen ini kepada seluruh jajaran di instansi saya.'
];

function refreshPreview(){
  const val=id=>(document.getElementById(id).value||'').replace(/[&<>]/g,'');
  const nama=val('nama'), inst=val('instansi'), jab=val('jabatan'), temp=val('tempat');
  const tglRaw=document.getElementById('tanggal').value;
  const tgl = tglRaw ? new Date(tglRaw).toLocaleDateString('id-ID',{dateStyle:'long'}) : '....................';
  const sig = (paths.length>0 || isUsingUpload) ? canvas.toDataURL() : '';

  const list = templateParagraphs.map(p=>`<li style="margin:6px 0;text-align:justify;">${p}</li>`).join('');

  document.getElementById('preview').innerHTML = `
    <div class="letter">
      <div class="title">SURAT PERNYATAAN</div>
      <div class="subtitle">Komitmen Anti Gratifikasi</div>
      <p>Yang bertanda tangan di bawah ini:</p>
      <table style="width:100%;font-size:14px;margin-bottom:10px">
        <tr><td width="150">Nama</td><td>: <b>${nama}</b></td></tr>
        <tr><td>Instansi</td><td>: <b>${inst}</b></td></tr>
        <tr><td>Jabatan</td><td>: <b>${jab}</b></td></tr>
      </table>
      <p>Dengan ini menyatakan bahwa:</p>
      <ol style="font-size:14px;padding-left:20px;">${list}</ol>
      <p>Demikian surat pernyataan ini dibuat dengan sebenar-benarnya.</p>
      <table style="width:100%;margin-top:30px">
        <tr><td width="60%"></td><td align="left">
          ${temp}, ${tgl}<br>Yang membuat pernyataan,<br><br>
          ${sig ? `<img src="${sig}" class="signature-img">` : `<div style="height:80px;border:1px dashed #ccc;"></div>`}
          <br><b>${nama}</b>
        </td></tr>
      </table>
    </div>`;
}
['nama','instansi','jabatan','tempat','tanggal'].forEach(i=>document.getElementById(i).oninput=refreshPreview);
refreshPreview();

// ==========================================
// 3. GENERATE PDF (A4 FIX)
// ==========================================
async function generatePdfBlobFromPreview(){
  refreshPreview();
  const el = document.querySelector('#preview .letter');
  const canvasCap = await html2canvas(el, { 
    scale: 2, useCORS: true, backgroundColor: '#ffffff', scrollY: 0, windowWidth: 800 
  }); 
  
  const imgData = canvasCap.toDataURL('image/jpeg', 0.6); 
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
  
  const pdfPageWidth = pdf.internal.pageSize.getWidth(); 
  const margin = 10; 
  const pdfWidth = pdfPageWidth - margin * 2; 
  const pdfHeight = (canvasCap.height * pdfWidth) / canvasCap.width; 

  pdf.addImage(imgData, 'JPEG', margin, margin, pdfWidth, pdfHeight); 
  return pdf.output('blob');
}

// ==========================================
// 4. UPLOAD LOGIC (FIXED FOR CORS & JSON)
// ==========================================
function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

function setStatus(msg, type){ 
    const s=document.getElementById('status'); 
    s.innerText=msg; s.className="status "+type; 
}

document.getElementById('doAll').onclick = async () => {
  if(APPSCRIPT_URL.includes("PASTE_URL")) { alert("URL Script belum diisi!"); return; }
  
  const btn = document.getElementById('doAll');
  btn.disabled = true;
  setStatus('Membuat PDF...', 'loading');

  try {
    const namaVal = (document.getElementById('nama').value || 'Surat').trim().replace(/\s+/g,'_');
    const filename = `${namaVal}_surat_pernyataan.pdf`;

    // 1. Generate
    const blob = await generatePdfBlobFromPreview();
    
    // 2. Convert to Base64
    const base64Data = await blobToBase64(blob);

    setStatus('Mengupload ke Drive...', 'loading');

    // 3. Prepare Payload
    const payload = {
      fileData: base64Data,
      filename: filename,
      mimeType: 'application/pdf'
    };

    // 4. SEND (Raw Text/Plain Body to avoid CORS Preflight)
    const resp = await fetch(APPSCRIPT_URL, {
      method: 'POST',
      // Jangan pakai JSON.stringify langsung di body tanpa trik ini jika server sensitif
      // Kita kirim sebagai text biasa, server akan parse sendiri.
      body: JSON.stringify(payload)
    });

    const res = await resp.json();

  if(res.status === 'success'){
      // ==========================================
      // SUKSES! Upload Berhasil. Sekarang Download.
      // ==========================================
      setStatus('Upload Berhasil! Mendownload file...', 'success');
      
      // A. Buka Tab Baru ke Google Drive (Opsional)
      window.open(res.url, '_blank');

      // B. DOWNLOAD OTOMATIS KE LAPTOP/HP
      // Membuat link download palsu lalu diklik otomatis
      const downloadLink = document.createElement('a');
      downloadLink.href = URL.createObjectURL(blob); // Gunakan blob yang sudah kita generate di langkah 1
      downloadLink.download = filename;              // Gunakan nama file yang sama
      document.body.appendChild(downloadLink);
      downloadLink.click();                          // Klik otomatis
      document.body.removeChild(downloadLink);       // Bersihkan

    } else {
      throw new Error(res.message);
    }

  } catch(e) {
    console.error(e);
    setStatus('Gagal: '+e.message, 'error');
  } finally {
    btn.disabled = false;
  }
};
</script>
</body>
</html>




