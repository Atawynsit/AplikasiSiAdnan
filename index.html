<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Generator Surat Pernyataan</title>

<style>
body {
  margin:0;
  font-family:Arial, sans-serif;
  background:#eef2f7;
}
.container {
  display:flex;
  height:100vh;
}
.left {
  width:380px;
  background:white;
  padding:20px;
  overflow-y:auto;
  border-right:1px solid #ccd3e2;
}
.right {
  flex:1;
  padding:20px;
  overflow-y:auto;
}
.preview-box {
  background:white;
  width:210mm;
  min-height:297mm;
  margin:auto;
  border:1px solid #ddd;
  padding:0;
}
label {
  margin-top:10px;
  font-size:14px;
  display:block;
}
input {
  width:100%;
  padding:8px;
  margin-top:4px;
  border:1px solid #ccc;
  border-radius:4px;
}
#sigCanvas {
  border:1px solid #ccc;
  width:100%;
  height:120px;
  margin-top:10px;
}
button {
  margin-top:12px;
  width:100%;
  padding:10px;
  background:#0b5ed7;
  border:none;
  color:white;
  border-radius:4px;
  cursor:pointer;
}
.status {
  margin-top:10px;
  font-size:14px;
}
.letter {
  padding:30px;
  font-family:"Times New Roman",serif;
}
</style>
</head>

<body>

<div class="container">

  <div class="left">
    <h2>Generator Surat</h2>

    <label>Nama</label>
    <input id="nama">

    <label>Instansi</label>
    <input id="instansi">

    <label>Jabatan</label>
    <input id="jabatan">

    <label>Tempat</label>
    <input id="tempat">

    <label>Tanggal</label>
    <input id="tanggal" type="date">

    <label>Upload Tanda Tangan</label>
    <input id="uploadSig" type="file" accept="image/*">

    <canvas id="sigCanvas"></canvas>

    <button id="clearSig">Bersihkan</button>
    <button id="useUpload">Gunakan Upload</button>
    <button id="generateUpload">Generate & Upload</button>

    <div id="status" class="status"></div>
  </div>

  <div class="right">
    <div id="preview" class="preview-box"></div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* --------------- SIGNATURE PAD ----------------- */
const canvas = document.getElementById("sigCanvas");
const ctx = canvas.getContext("2d");
canvas.width = canvas.offsetWidth;
canvas.height = canvas.offsetHeight;

let drawing = false, paths = [], uploadedSig = "", sigData = "";

canvas.addEventListener("pointerdown", e => {
  drawing = true;
  paths.push([{x:e.offsetX,y:e.offsetY}]);
});
canvas.addEventListener("pointermove", e => {
  if(!drawing) return;
  paths[paths.length-1].push({x:e.offsetX,y:e.offsetY});
  drawSig();
});
canvas.addEventListener("pointerup", ()=> drawing=false);

function drawSig(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#000";
  ctx.lineJoin = "round";
  for(const p of paths){
    ctx.beginPath();
    ctx.moveTo(p[0].x, p[0].y);
    for(const t of p) ctx.lineTo(t.x,t.y);
    ctx.stroke();
  }
}

document.getElementById("clearSig").onclick = ()=>{
  paths = [];
  uploadedSig = "";
  sigData = "";
  ctx.clearRect(0,0,canvas.width,canvas.height);
  renderPreview();
};

document.getElementById("uploadSig").onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    uploadedSig = ev.target.result;
    sigData = uploadedSig;
    renderPreview();
  };
  reader.readAsDataURL(file);
};

document.getElementById("useUpload").onclick = ()=>{
  if(uploadedSig) sigData = uploadedSig;
  else if(paths.length>0) sigData = canvas.toDataURL();
  renderPreview();
};

/* --------------- PREVIEW ----------------- */
function escapeHTML(str=""){ return str.replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

function renderPreview(){
  const nama = escapeHTML(document.getElementById("nama").value);
  const inst = escapeHTML(document.getElementById("instansi").value);
  const jab = escapeHTML(document.getElementById("jabatan").value);
  const tempat = escapeHTML(document.getElementById("tempat").value);
  const tgl = document.getElementById("tanggal").value;

  const sig = sigData || (paths.length ? canvas.toDataURL() : "");

  document.getElementById("preview").innerHTML = `
  <div class="letter">
    <h2 style="text-align:center;">SURAT PERNYATAAN</h2>

    <p>Yang bertanda tangan di bawah ini:</p>
    <p>
      Nama: <b>${nama}</b><br>
      Instansi: <b>${inst}</b><br>
      Jabatan: <b>${jab}</b>
    </p>

    <p>Menyatakan komitmen anti gratifikasi.</p>

    <p>${tempat}, ${tgl}</p>

    ${sig ? `<img src="${sig}" width="150">` : `<br><br><br>`}

    <p><b>${nama}</b></p>
  </div>`;
}

["nama","instansi","jabatan","tempat","tanggal"]
  .forEach(id => document.getElementById(id).addEventListener("input", renderPreview));
renderPreview();

/* --------------- PDF + BASE64 UPLOAD ----------------- */
const APPSCRIPT_URL = "PASTE_URL_WEB_APP_ANDA";

function setStatus(msg, error=false){
  const s=document.getElementById("status");
  s.textContent = msg;
  s.style.color = error ? "red":"black";
}

async function blobToBase64(blob){
  return new Promise(resolve=>{
    const reader = new FileReader();
    reader.onload = ()=> resolve(reader.result.split(",")[1]);
    reader.readAsDataURL(blob);
  });
}

async function generatePDF(){
  const el = document.getElementById("preview");
  const canvasCap = await html2canvas(el,{scale:1,background:"#fff"});
  const img = canvasCap.toDataURL("image/png");

  const pdf = new jspdf.jsPDF("p","mm","a4");
  pdf.addImage(img,"PNG",0,0,210,297);
  return pdf.output("blob");
}

async function uploadToDrive(blob, filename){
  const base64 = await blobToBase64(blob);

  const payload = {
    filename: filename,
    mimeType: "application/pdf",
    fileData: base64
  };

  const req = await fetch(APPSCRIPT_URL,{
    method:"POST",
    body:JSON.stringify(payload),
    headers:{"Content-Type":"application/json"}
  });

  return req.json();
}

document.getElementById("generateUpload").onclick = async ()=>{
  setStatus("Membuat PDF...");

  const nama = (document.getElementById("nama").value||"dokumen").replace(/\s+/g,"_");
  const filename = nama + "_surat_pernyataan.pdf";

  const blob = await generatePDF();

  setStatus("Mengupload ke Drive...");

  const res = await uploadToDrive(blob, filename);

  if(res.status==="success"){
    setStatus("Berhasil diunggah!");
    alert("Upload sukses!\n" + res.url);
  } else {
    setStatus("Upload gagal", true);
    alert("Upload gagal:\n" + JSON.stringify(res));
  }
};
</script>

</body>
</html>

