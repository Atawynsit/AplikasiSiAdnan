<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Generator Surat Pernyataan — (Generate & Send)</title>

<style>
:root{--accent:#0b5ed7;--muted:#6b7280}
body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; margin:0;background:#f3f6fa;color:#0b2545}
.wrap{max-width:1100px;margin:18px auto;padding:18px}
.card{background:#fff;border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(12,24,60,0.06)}
h1{font-size:18px;margin:0 0 10px}
label{display:block;font-size:13px;margin-top:10px;color:var(--muted)}
.input, input[type=text], input[type=date], textarea, select{width:100%;padding:10px;border:1px solid #e6eefc;border-radius:8px;font-size:14px;box-sizing:border-box}
.grid{display:grid;grid-template-columns:1fr 520px;gap:18px}
.note{font-size:13px;color:var(--muted);margin-top:8px}
.preview-frame{border:1px solid #e6eefc;padding:18px;border-radius:8px;background:#fff;min-height:1120px}
.letter{font-family: 'Times New Roman', serif;color:#000;padding:28px;width:210mm;box-sizing:border-box}
.title{ text-align:center;font-weight:bold;font-size:16pt }
.subtitle{ text-align:center;font-size:11pt;margin-top:4px;margin-bottom:18px }
.info-table td{padding:3px 6px;vertical-align:top}
.signature-img{max-width:180px;display:block}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.btn{background:var(--accent);color:white;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;border:1px solid #dbe9ff;color:var(--accent)}
.status{margin-top:12px;font-size:13px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
/* A4 print helper */
.a4-container { display:flex; justify-content:center; }
</style>

</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Generator Surat Pernyataan — Komitmen Anti Gratifikasi</h1>
    <p class="note">Isi form, buat atau upload tanda tangan, lalu klik <strong>Generate & Send</strong> (otomatis download & upload ke Google Drive).</p>

    <div class="grid">
      <div>
        <label>Nama</label>
        <input id="nama" type="text" placeholder="Nama lengkap" />

        <label>Instansi / Perusahaan</label>
        <input id="instansi" type="text" placeholder="Contoh: Ditjen Perbendaharaan" />

        <label>Jabatan / Posisi</label>
        <input id="jabatan" type="text" placeholder="Contoh: Pelaksana" />

        <label>Tempat (ttd)</label>
        <input id="tempat" type="text" placeholder="Contoh: Jakarta" />

        <label>Tanggal (ttd)</label>
        <input id="tanggal" type="date" />

        <label>Tanda tangan — upload gambar atau gambar di canvas</label>
        <input id="uploadSig" type="file" accept="image/*" />
        <div class="note">Atau buat tanda tangan dengan mouse / pen:</div>
        <canvas id="sigCanvas" width="420" height="120" style="border:1px solid #ddd;border-radius:6px;display:block;margin-top:8px;background:#fff"></canvas>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn ghost" id="clearSig">Bersihkan</button>
          <button class="btn ghost" id="undoSig">Undo</button>
          <button class="btn ghost" id="useUpload">Gunakan Gambar Upload</button>
        </div>

        <div class="controls">
          <!-- single combined button -->
          <button class="btn" id="doAll">Generate & Send</button>
        </div>

        <div class="status" id="status"></div>
      </div>

      <div>
        <div class="card" style="padding:12px">
          <div id="preview" class="preview-frame a4-container">
            <!-- preview render here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// ---------------- signature pad ----------------
const canvas = document.getElementById('sigCanvas');
const ctx = canvas.getContext('2d');
let drawing=false; let paths=[];
canvas.addEventListener('pointerdown', e=>{ drawing=true; const r=canvas.getBoundingClientRect(); const x=(e.clientX-r.left)*(canvas.width/r.width); const y=(e.clientY-r.top)*(canvas.height/r.height); paths.push([{x,y}]); draw(); });
canvas.addEventListener('pointermove', e=>{ if(!drawing) return; const r=canvas.getBoundingClientRect(); const x=(e.clientX-r.left)*(canvas.width/r.width); const y=(e.clientY-r.top)*(canvas.height/r.height); paths[paths.length-1].push({x,y}); draw(); });
canvas.addEventListener('pointerup', ()=>{ drawing=false; });
canvas.addEventListener('pointerleave', ()=>{ drawing=false; });
function draw(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.lineWidth=2.4; ctx.lineJoin='round'; ctx.lineCap='round'; ctx.strokeStyle='#0b2545'; for(const p of paths){ if(p.length===0) continue; ctx.beginPath(); ctx.moveTo(p[0].x,p[0].y); for(let i=1;i<p.length;i++) ctx.lineTo(p[i].x,p[i].y); ctx.stroke(); } }
document.getElementById('clearSig').addEventListener('click', ()=>{ paths=[]; draw(); uploadedSig=''; sigDataForLetter=''; refreshPreview(); });
document.getElementById('undoSig').addEventListener('click', ()=>{ paths.pop(); draw(); refreshPreview(); });

// upload handler
let uploadedSig=''; const uploadEl = document.getElementById('uploadSig');
uploadEl.addEventListener('change', (ev)=>{ const f = ev.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload = e=>{ uploadedSig = e.target.result; document.getElementById('useUpload').innerText='Gunakan Gambar Upload (aktif)'; drawUploadedOnCanvas(uploadedSig); }; reader.readAsDataURL(f); });
function drawUploadedOnCanvas(data){ const img=new Image(); img.onload=()=>{ draw(); ctx.drawImage(img, 10, 8, canvas.width-20, canvas.height-16); }; img.src=data; }

// use upload
let sigDataForLetter = '';
document.getElementById('useUpload').addEventListener('click', ()=>{ if(uploadedSig){ sigDataForLetter = uploadedSig; statusMsg('Tanda tangan upload dipakai pada preview'); refreshPreview(); } else alert('Belum ada gambar terupload.'); });

// helper to get canvas data url (for printed signature)
function getCanvasDataUrl(){ const temp = document.createElement('canvas'); temp.width = canvas.width; temp.height = canvas.height; const tctx = temp.getContext('2d'); tctx.fillStyle='white'; tctx.fillRect(0,0,temp.width,temp.height); tctx.lineWidth=2.4; tctx.lineJoin='round'; tctx.lineCap='round'; tctx.strokeStyle='#0b2545'; for(const p of paths){ if(!p.length) continue; tctx.beginPath(); tctx.moveTo(p[0].x,p[0].y); for(let i=1;i<p.length;i++) tctx.lineTo(p[i].x,p[i].y); tctx.stroke(); } return temp.toDataURL('image/png'); }

// template paragraphs
const templateParagraphs = [
  'Saya menyadari sepenuhnya bahwa pemberian/penerimaan suap dan gratifikasi merupakan perbuatan korupsi yang menciderai nilai integritas dan melanggar norma hukum.',
  'Saya memahami dan mendukung penuh kebijakan pencegahan gratifikasi, benturan kepentingan, dan penguatan integritas di lingkungan Kementerian Keuangan, khususnya Direktorat Jenderal Perbendaharaan.',
  'Saya berkomitmen untuk tidak memberikan uang, hadiah, fasilitas, komisi, imbalan, hiburan, ataupun bentuk pemberian lainnya kepada pejabat/pegawai di lingkungan Direktorat Jenderal Perbendaharaan, baik secara langsung maupun tidak langsung, dalam bentuk apa pun yang berkaitan dengan Kerjasama atau layanan Ditjen Perbendaharaan.',
  'Saya bersedia melaporkan kepada pimpinan Ditjen Perbendaharaan melalui saluran pelaporan yang tersedia (WISE atau SIPANDU) apabila mengetahui adanya oknum Ditjen Perbendaharaan yang meminta atau menerima gratifikasi atas layanan yang diberikan.',
  'Saya akan meneruskan pesan komitmen ini kepada seluruh unit/kantor vertikal, kantor cabang, atau perwakilan Instansi/Perusahaan kami agar tidak memberikan pemberian dalam bentuk apa pun kepada pejabat/pegawai DJPb atas Kerjasama atau layanan Ditjen Perbendaharaan.'
];

// build letter HTML
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function formatDateInput(dateStr){ if(!dateStr) return ''; const d = new Date(dateStr); const opts = { day:'2-digit', month:'long', year:'numeric' }; return d.toLocaleDateString('id-ID', opts); }

function buildLetterHtml(data){
  const nama = data.nama||'....................................................';
  const inst = data.instansi||'....................................................';
  const jab = data.jabatan||'....................................................';
  const tempat = data.tempat||'Jakarta';
  const tgl = data.tanggal ? formatDateInput(data.tanggal) : 'November 2025';
  const sig = sigDataForLetter || (paths.length>0 ? getCanvasDataUrl() : '');

  const listHtml = templateParagraphs.map(p=>`<li style="margin:6px 0;text-align:justify;">${escapeHtml(p)}</li>`).join('');

  return `
    <div class="letter" style="background:white;margin:0 auto;">
      <div class="title">SURAT PERNYATAAN</div>
      <div class="subtitle">Komitmen Tidak Memberikan Sesuatu atas Layanan Direktorat Jenderal Perbendaharaan</div>

      <p>Yang bertanda tangan di bawah ini:</p>
      <table style="width:100%;font-size:14px;margin-bottom:10px" class="info-table">
        <tr><td style="width:160px">Nama</td><td>: <strong>${escapeHtml(nama)}</strong></td></tr>
        <tr><td>Instansi/Perusahaan</td><td>: <strong>${escapeHtml(inst)}</strong></td></tr>
        <tr><td>Jabatan</td><td>: <strong>${escapeHtml(jab)}</strong></td></tr>
      </table>

      <p>Dengan ini menyatakan bahwa:</p>
      <div style="font-size:14px"><ol style="font-size:14px;padding-left:22px;margin:0;">${listHtml}</ol></div>

      <p style="margin-top:12px">Demikian surat pernyataan ini dibuat untuk mendukung penguatan integritas Ditjen Perbendaharaan.</p>

      <table style="width:100%;margin-top:28px" class="signature-table">
        <tr>
          <td style="width:60%"></td>
          <td style="width:40%;text-align:left">
            ${escapeHtml(tempat)}, ${escapeHtml(tgl)}<br>
            Yang membuat pernyataan,<br><br>
            ${ sig ? `<img src="${sig}" class="signature-img" />` : `<div style="width:150px;height:80px;border:1px dashed #ccc;margin-bottom:6px"></div>` }
            <div style="margin-top:8px"><b>${escapeHtml(nama)}</b></div>
          </td>
        </tr>
      </table>
    </div>
  `;
}

// preview render
function refreshPreview(){
  const data = { nama: document.getElementById('nama').value, instansi: document.getElementById('instansi').value, jabatan: document.getElementById('jabatan').value, tempat: document.getElementById('tempat').value, tanggal: document.getElementById('tanggal').value };
  if(!sigDataForLetter){ if(paths.length>0) sigDataForLetter = getCanvasDataUrl(); }
  const html = buildLetterHtml(data);
  const container = document.getElementById('preview');
  container.innerHTML = `<div style="width:210mm;max-width:100%">${html}</div>`;
}
['nama','instansi','jabatan','tempat','tanggal'].forEach(id=>document.getElementById(id).addEventListener('input', refreshPreview));

// initial preview
refreshPreview();

// ---------------- PDF generate + download + upload ----------------
// <- paste your Apps Script URL here (make sure it's the final deployed Web App URL)
const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbxI-Z7VvtLmCPhL4yUcyg4cSdCNh8xlQBRZCeL6tnHpUOFyI4i7ubRWnCka35P0GjLd/exec";

function statusMsg(t, isError=false){
  const el = document.getElementById('status');
  el.textContent = t;
  el.style.color = isError ? 'crimson' : 'inherit';
}

async function generatePdfBlobFromPreview(){
  // ensure preview up to date
  refreshPreview();
  const el = document.querySelector('#preview .letter');
  // render with html2canvas at high scale
  const canvasCap = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
  const imgData = canvasCap.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
  const pageWidth = pdf.internal.pageSize.getWidth();
  const margin = 12;
  const pdfWidth = pageWidth - margin*2;
  const ratio = canvasCap.width / pdfWidth;
  const pdfHeight = canvasCap.height / ratio;
  pdf.addImage(imgData, 'PNG', margin, margin, pdfWidth, pdfHeight);
  const blob = pdf.output('blob');
  return blob;
}

function triggerDownload(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function uploadBlobToAppsScript(blob, filename){
  try {
    // FormData with file
    const fd = new FormData();
    fd.append('file', blob, filename);
    fd.append('filename', filename);
    fd.append('mimeType', 'application/pdf');

    const resp = await fetch(APPSCRIPT_URL, {
      method: 'POST',
      body: fd
    });

    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error('HTTP ' + resp.status + ' — ' + txt);
    }

    // Apps Script usually returns text; attempt parse
    let txt = await resp.text();
    try { return JSON.parse(txt); } catch(e) { return { status: 'unknown', raw: txt }; }

  } catch (err) {
    // bubble error up
    return { status: 'error', message: err.toString() };
  }
}

// Single button handler: generate -> download -> upload
document.getElementById('doAll').addEventListener('click', async ()=>{
  try {
    statusMsg('Membuat PDF ...');
    const namaVal = (document.getElementById('nama').value || 'surat').trim().replace(/\s+/g,'_');
    const filename = `${namaVal}_surat_pernyataan.pdf`;
    const blob = await generatePdfBlobFromPreview();

    statusMsg('Mengunduh PDF ke browser ...');
    triggerDownload(blob, filename);

    statusMsg('Mengunggah ke Google Drive ...');
    const res = await uploadBlobToAppsScript(blob, filename);

    if(res && res.status === 'success'){
      statusMsg('Berhasil diunggah. File URL: ' + (res.url || res.fileId));
      alert('Berhasil: file tersimpan di Drive.\nURL: ' + (res.url || res.fileId));
    } else {
      console.error('Upload response:', res);
      statusMsg('Upload gagal — lihat console untuk detail', true);
      alert('Upload gagal. Respons server: ' + JSON.stringify(res));
    }
  } catch(err){
    console.error(err);
    statusMsg('Terjadi kesalahan: ' + (err && err.message ? err.message : err), true);
    alert('Error: ' + (err && err.message ? err.message : err));
  }
});
</script>
</body>
</html>

